#!/usr/bin/zsh

if [[ "$verbose" == "on" ]]; then
	echo "[verbosity on, setting -x mode]"; set -x
fi

src() {
. "$HOME/.zshrc"
}

pause() {
    prompt="$1"
    echo -e -n "\033[1;36m$prompt"
    echo -e -n '\033[0m'
    read
}

usage () {
echo "usage: yazt [-uhvSQT] [--usage] [--help] [--version} [--sync [THEME]] [--query]"
}

help () {
echo "usage: yazt <operation> [...]"
echo "operations:"
echo "    yazt {-u --usage}"
echo "    yazt {-h --help}"
echo "    yazt {-v --version}"
echo "    yazt {-S --sync} [user/theme] [-u {gitee/github}]"
echo "    yazt {-Q --qnadoc} [docpage]"
echo "    yazt {-Rt --rolltag} [tag]"
echo "    yazt {-Rb --rollbranch} [branch]}"
echo ""
echo "use yazt -hh for more info"
}

helpadvanced () {
usage
echo ""
echo "Normal operations:"
echo "{-S --sync} [user/theme] [-u {gitee/github}]: copy a theme; without input, list themes"
echo "    [user/theme]: repository including the theme"
echo "    [-u {gitee,github}]: repo mirror to copy from"
echo "    [-Sy]: updates Yazt"
echo "{-Q --qnadoc} [docpage]: Document specific things about Yazt"
echo "    [docpage]: docpage with info you need"
echo "{-T --tag}: rolls back and forth your tag/version using Git"
}

nocommand () {
echo "no command specified or command not found (use yazt -h for help)"
usage
exit 1
}

version () {
echo "yazt version $yaztver"
echo "zsh version ${ZSH_VERSION}"
echo "$(git --version)"
}

update () {
echo "Pulling Yazt from official mirrors..."
if git -C $yazt pull; then
	echo "Sucessfully updated"
else
	echo "There was an error updating Yazt."
	exit 1
fi
}

themelist () {
echo "In the default themes:"
ls $yazt/themes
echo "In fetched themes:"
ls $yaztcustom/themes
}

 themeuse () {
  theme=${1/*\/}
   if [ -f "$yaztcustom/${theme}.yzt" ]; then
     echo "$theme already exists. Set it from your rc."
   elif [ -f "$yaztcustom/themes/${theme}.yzt" ]; then
     echo "$theme already exists. Set it from your rc."
   elif [ -f "$yazt/themes/${theme}.yzt" ]; then
     echo "$theme already exists. Set it from your rc."
   else
     echo "Copying $1..."
     if [[ "$2" == "gitee" ]]; then
       git clone https://gitee.com/$1 $yazt/etc/cache/$theme
     else
       git clone https://github.com/$1 $yazt/etc/cache/$theme
     fi
     themepath="$yazt/etc/cache/$theme"
     if [[ -f $themepath/$theme.yzt ]]; then
       mv $themepath/$theme.yzt $yaztcustom/themes
       rm -rf $themepath
       echo "Done!"
     elif [[ -f $themepath/$theme.zsh ]]; then
       echo "Could not find $theme.yzt, resorting to $theme.zsh"
       mv $themepath/$theme.zsh $yaztcustom/themes
       rm -rf $themepath
     echo "Done!"
     else
       echo "Could not find $theme.yzt or $theme.zsh in repo"
       rm -rf $themepath
     fi 
   fi
 }

doc () {
if [[ -z $1 ]]; then
	echo "No doc specified."
else
	if [[ -f $yazt/etc/doc/$1.txt ]]; then
		cat $yazt/etc/doc/$1.txt | less
	else
		echo "Doc not found."
	fi
fi
}

rolltag () {
if [[ -z $1 ]]; then
	echo "No tag specified."
	exit 1
fi
if git -C $yazt checkout tags/$1; then
	echo "Switched to tag/version $1"
else
	echo "Error switching."
fi
}
src
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
	help
elif [[ "$1" == "-hh" ]]; then
	helpadvanced
elif [[ "$1" == "-v" || "$1" == "--version" ]]; then
	version
elif [[ "$1" == "-Syu" || "$1" == "--update" ]]; then
	update
elif [[ "$1" == "-S" || "$1" == "--sync" ]]; then
 	if [[ -z $2 ]]; then
 		themelist
 	else
		if [[ "$3" == "-u" ]]; then
			themeuse $2 $4
		else
			themeuse $2
		fi
 	fi
elif [[ "$1" == "-u" || "$1" == "--usage" ]]; then
	usage
elif [[ "$1" == "-Q" || "$1" == "--qnadoc" ]]; then
	doc $2
elif [[ "$1" == "-T" || "$1" == "--tag" ]]; then
	rolltag $2
else
	nocommand
fi
