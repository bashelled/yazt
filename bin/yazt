#!/usr/bin/zsh

if [[ "$verbose" == "on" ]]; then
	echo "[verbosity on, setting -x mode]"; set -x
fi

src() {
. "$HOME/.zshrc"
}

pause() {
    prompt="$1"
    echo -e -n "\033[1;36m$prompt"
    echo -e -n '\033[0m'
    read
}

usage () {
echo "usage: yazt [-uhvRSQ] [--usage] [--help] [--version] [--remove] [--sync [THEME]] [--pull]"
}

help () {
echo "usage: yazt <operation> [...]"
echo "operations:"
echo "    yazt {-u --usage}"
echo "    yazt {-h --help}"
echo "    yazt {-v --version}"
echo "    yazt {-R --remove}"
echo "    yazt {-S --sync} [user/theme] [-u {gitee/github}]"
echo "    yazt {-Q --query} [docpage]"
echo ""
echo "use yazt -hh for more info"
}

helpadvanced () {
usage
echo ""
echo "Normal operations:"
echo "{-R --remove}: uninstall Yazt from your computer and recopys your old zshrc"
echo "{-S --sync} [user/theme] [-u {gitee/github}]: copy a theme; without input, list themes"
echo "    [user/theme]: repository including the theme"
echo "    [-u {gitee,github}]: repo mirror to copy from"
echo "{-P --pull}: pull and copy updates from the Yazt mirror to your local install"
echo "{-Q --query} [docpage]: Document specific things about Yazt"
}

nocommand () {
echo "no command specified or command not found (use yazt -h for help)"
usage
exit 1
}

version () {
echo "yazt version $yaztver"
echo "zsh version ${ZSH_VERSION}"
echo "$(git --version)"
}

uninstall () {
pause "Really uninstall Yazt? :: "
pause "Are you sure? :: "
pause "{!!} WARNING! THIS WILL REVERT TO YOUR ORIGINAL ZSH PROMPT! Are you sure? {!!} :: "
rm -rfv $yazt/plugins
rm -rfv $yazt/themes
rm -rfv $yazt/etc
cat ~/.zshrc.preyazt > ~/.zshrc
rm -rfv ~/.zshrc.preyazt
echo "Done! Remove your \$yazt file."
}

update () {
echo "Pulling Yazt from official mirrors..."
if git -C $yazt pull; then
	echo "Sucessfully updated"
else
	echo "There was an error updating Yazt."
	exit 1
fi
}

themelist () {
ls $yazt/themes
ls $yaztcustom/themes
}

 themeuse () {
  theme=${1/*\/}
   if [ -f "$yaztcustom/${theme}.yzt" ]; then
     echo "$theme already exists. Set it from your rc."
   elif [ -f "$yaztcustom/themes/${theme}.yzt" ]; then
     echo "$theme already exists. Set it from your rc."
   elif [ -f "$yazt/themes/${theme}.yzt" ]; then
     echo "$theme already exists. Set it from your rc."
   else
     echo "Copying $1..."
     if [[ "$2" == "gitee" ]]; then
       git clone https://gitee.com/$1 $yazt/etc/cache/$theme
     else
       git clone https://github.com/$1 $yazt/etc/cache/$theme
     fi
     themepath="$yazt/etc/cache/$theme"
     if [[ -f $themepath/$theme.yzt ]]; then
       mv $themepath/$theme.yzt $yaztcustom/themes
       rm -rf $themepath
       echo "Done!"
     elif [[ -f $themepath/$theme.zsh ]]; then
       echo "Could not find $theme.yzt, resorting to $theme.zsh"
       mv $themepath/$theme.zsh $yaztcustom/themes
       rm -rf $themepath
     echo "Done!"
     else
       echo "Could not find $theme.yzt or $theme.zsh in repo"
       rm -rf $themepath
     fi 
   fi
 }

doc () {
if [[ -z $1 ]]; then
	echo "No doc specified."
else
	if [[ -f $yazt/etc/doc/$1.txt ]]; then
		cat $yazt/etc/doc/$1.txt | less
	else
		echo "Doc not found."
	fi
fi
}

src
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
	help
elif [[ "$1" == "-hh" ]]; then
	helpadvanced
elif [[ "$1" == "-v" || "$1" == "--version" ]]; then
	version
elif [[ "$1" == "-R" || "$1" == "--remove" ]]; then
	uninstall
elif [[ "$1" == "-P" || "$1" == "--pull" ]]; then
	update
elif [[ "$1" == "-S" || "$1" == "--sync" ]]; then
 	if [[ -z $2 ]]; then
 		themelist
 	else
		if [[ "$3" == "-u" ]]; then
			themeuse $2 $4
		else
			themeuse $2
		fi
 	fi
elif [[ "$1" == "-u" || "$1" == "--usage" ]]; then
	usage
elif [[ "$1" == "-Q" || "$1" == "--query" ]]; then
	doc $2
else
	nocommand
fi
